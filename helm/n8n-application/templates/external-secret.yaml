{{- if .Values.externalSecrets.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-external-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "n8n-application.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" | quote }}
  secretStoreRef:
    name: vault-backend
    kind: SecretStore

  # The Kubernetes Secret that ESO will create/manage
  target:
    name: postgres-secret
    creationPolicy: Owner
    deletionPolicy: Retain

  # Map Vault KV keys â†’ Kubernetes Secret keys
  data:
    - secretKey: POSTGRES_USER
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: POSTGRES_USER

    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: POSTGRES_PASSWORD

    - secretKey: POSTGRES_DB
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: POSTGRES_DB

    - secretKey: POSTGRES_NON_ROOT_USER
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: POSTGRES_NON_ROOT_USER

    - secretKey: POSTGRES_NON_ROOT_PASSWORD
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: POSTGRES_NON_ROOT_PASSWORD
{{- end }}
